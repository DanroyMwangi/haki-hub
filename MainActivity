package com.example.haki_hub;

import androidx.annotation.NonNull
import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel
import android.content.Intent
import android.os.Build
import android.net.Uri
import org.json.JSONObject
import org.json.JSONException

public class MainActivity : FlutterActivity() {
  companion object {
      private const val CHANNEL = "com.example.haki_hub/nativeModule"
  }
    override fun configureFlutterEngine(@NonNull flutterEngine: FlutterEngine){
        super.configureFlutterEngine(flutterEngine)
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler {call, result ->
            when (call.method){
                "getDeviceInfo" -> result.success(getDeviceInfo())
                "getCivicEducation" -> results.success(getCivicEducation())
                "getResources" -> result.success(getResources())
                "navigateHome" -> {
                    navigateHome()
                    result.success(null)
                }
                "openExternalLink" -> {
                    val url = call.argument<String>("url")
                    url?.let{openExternalLink(it)}
                    result.success(null)
                }
                "handleIconTap" -> {
                    val iconID = call.argument<String>("iconID")
                    result.success(null)
                }
                else -> result.notImplemented()
            }
        }
    }
    private fun getDeviceInfo(): String{
        return "Android ${Build.VERSION.RELEASE}"
    }

    private fun getCivicEducation(): String{
        val civicEducation= JSONObject()
        try{
            civicEducation.put("Finance Bill 2024", "Learn about the Proposed Finance Bill")
            civicEducation.put("Data Protection Act", "Learn about the 2019 data protection act")
            civicEducation.put("Protesting Rights", "Learn about your constitutional right")
            civicEducation.put("ICT Bill", "Learn about the ICT bill")
        } catch(e: JSONException){
            e.printStackTrace()

        }
    return civicEducation.toString()
    }

    private fun getResources(): String{
        val resources = JSONObject()
        try {
           resources.put("Tear Gas Exposure", "Get help with tear gas exposure, injury and more")
            resources.put("Mental Health", "Get help with any distress including trauma, panic etc")
        } catch (e: JSONException){
            e.printStackTrace()
        }
        return resources.toString()
    }

    private fun navigateHome(){
        println("Home button pressed")
        if(isOnHomeScreen()){
            refreshHomeScreen()
        }
        else{
            gotoHomeScreen()
        }
    }

    private fun isOnHomeScreen(): Boolean{
        //Logic Implementation
        return false //Placeholder: In the event we are not on the homescreen
    }

    private fun refreshHomeScreen(){
        println("Refreshing home screen")

        //Implement logic to refresh home screen content which may involve fetching new data or updating of UI elements
        //Notify flutter to refresh the home screen
        channel.invokeMethod("refreshHomeScreen", null)
    }

    private fun gotoHomeScreen(){
        println("Refreshing to HomeScreen")
        //Implement logic to navigate to the home screen
        /*val intent = Intent(this, HomeActivity::class.java)
        intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_SINGLE_TOP
        startActivity(intent)
         */

        channel.invokeMethod("onHomeScreenReached", null)
    }
    private fun openExternalLink(url: String){
        val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
        startActivity(intent)
    }
    private fun handleIconTap(iconID: String?): String{
        return when (iconID){
            "financeBill2024" -> openFinanceBill()
            "dataProtection" -> openDataProtectionInfo()
            "protestingRights" -> openProtestingrightsInfo()
            "ICTBill" -> openICTBillInfo()
            "tearGasHelp" -> openTearGasHelp()
            "mentalHealth" -> openMentalHealthInfo()
            else -> "unknown icon"
        }
    }
    private fun openFinanceBill(): String{
        //Logic Implementation
        val intent = Intent(this, FinanceBookActivity::class.java)
        startActivity(intent)
        return "Open Finance Bill 2024 info"
    }
    private fun openDataProtectionInfo(): String {
        //Logic implementation
        val intent = Intent(this, DataProtectionActivity::class.java)
        startActivity(intent)
        return "Opened Data Protection Act Info"
    }
    private fun openProtestingRightsInfo(): String {
        //Logic Implementation
        val intent = Intent(this, ProtestingRightsActivity::class.java)
        startActivity(intent)
        return "Opened Protesting Rights Info"
    }
    private fun openICTBillInfo(): String {
        //Logic Implementation
        val intent: Intent(this, ICTBillActivity::class.java)
        startActivity(intent)
        return "Opened ICT Bill Info"
    }
    private fun openTearGasHelpInfo(): String{
        //Logic Implementation
        val url = "url"
        openExternalLink(url)
        return "Opened Metal Health Resources"
    }
}
